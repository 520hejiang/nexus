#!/bin/bash

# NEXUSèŠ‚ç‚¹ä¼˜åŒ–è„šæœ¬
# é€‚ç”¨äºä½é…ç½®ç¡¬ä»¶ (i5-6200U, 4GB RAM, NVIDIA 920MX)
# ä½œè€…: Claude AIåŠ©æ‰‹

echo "==================================="
echo "    NEXUS èŠ‚ç‚¹ä¼˜åŒ–è„šæœ¬ v1.0"
echo "==================================="

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ£€æŸ¥æ˜¯å¦ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ
check_admin() {
    if [[ $EUID -eq 0 ]]; then
        echo -e "${GREEN}âœ“ ç®¡ç†å‘˜æƒé™æ£€æŸ¥é€šè¿‡${NC}"
    else
        echo -e "${RED}âœ— è¯·ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œæ­¤è„šæœ¬${NC}"
        echo "Linux/Mac: sudo $0"
        echo "Windows: ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
        exit 1
    fi
}

# ç³»ç»Ÿä¿¡æ¯æ£€æµ‹
check_system() {
    echo -e "\n${BLUE}[1/8] æ£€æµ‹ç³»ç»Ÿä¿¡æ¯...${NC}"
    
    OS=$(uname -s)
    echo "æ“ä½œç³»ç»Ÿ: $OS"
    
    # CPUä¿¡æ¯
    if command -v lscpu &> /dev/null; then
        CPU_CORES=$(lscpu | grep "^CPU(s):" | awk '{print $2}')
        CPU_MODEL=$(lscpu | grep "Model name" | cut -d: -f2 | xargs)
        echo "CPU: $CPU_MODEL"
        echo "CPUæ ¸å¿ƒæ•°: $CPU_CORES"
    else
        CPU_CORES=4  # é»˜è®¤å€¼
        echo "CPUæ ¸å¿ƒæ•°: $CPU_CORES (é»˜è®¤)"
    fi
    
    # å†…å­˜ä¿¡æ¯
    if command -v free &> /dev/null; then
        TOTAL_MEM=$(free -h | awk '/^Mem:/ {print $2}')
        echo "æ€»å†…å­˜: $TOTAL_MEM"
    else
        echo "å†…å­˜: 4GB + 16GBè™šæ‹Ÿå†…å­˜"
    fi
}

# ç³»ç»Ÿä¼˜åŒ–
optimize_system() {
    echo -e "\n${BLUE}[2/8] ç³»ç»Ÿä¼˜åŒ–è®¾ç½®...${NC}"
    
    # Linuxç³»ç»Ÿä¼˜åŒ–
    if [[ "$OS" == "Linux" ]]; then
        echo "æ­£åœ¨ä¼˜åŒ–Linuxç³»ç»Ÿå‚æ•°..."
        
        # ä¼˜åŒ–è™šæ‹Ÿå†…å­˜ä½¿ç”¨
        echo "vm.swappiness=10" >> /etc/sysctl.conf 2>/dev/null || echo "æ— æ³•ä¿®æ”¹swappinessè®¾ç½®"
        
        # ä¼˜åŒ–æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
        echo "* soft nofile 65536" >> /etc/security/limits.conf 2>/dev/null || true
        echo "* hard nofile 65536" >> /etc/security/limits.conf 2>/dev/null || true
        
        # åº”ç”¨è®¾ç½®
        sysctl -p 2>/dev/null || true
        
        echo -e "${GREEN}âœ“ Linuxç³»ç»Ÿä¼˜åŒ–å®Œæˆ${NC}"
    fi
    
    # macOSç³»ç»Ÿä¼˜åŒ–
    if [[ "$OS" == "Darwin" ]]; then
        echo "æ­£åœ¨ä¼˜åŒ–macOSç³»ç»Ÿå‚æ•°..."
        
        # å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
        launchctl limit maxfiles 65536 65536 2>/dev/null || true
        
        echo -e "${GREEN}âœ“ macOSç³»ç»Ÿä¼˜åŒ–å®Œæˆ${NC}"
    fi
}

# æ¸…ç†ç³»ç»Ÿèµ„æº
cleanup_resources() {
    echo -e "\n${BLUE}[3/8] æ¸…ç†ç³»ç»Ÿèµ„æº...${NC}"
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if [[ "$OS" == "Linux" ]]; then
        # æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
        if command -v apt-get &> /dev/null; then
            apt-get clean 2>/dev/null || true
            apt-get autoclean 2>/dev/null || true
        fi
        
        if command -v yum &> /dev/null; then
            yum clean all 2>/dev/null || true
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        find /tmp -type f -atime +7 -delete 2>/dev/null || true
    fi
    
    # æ¸…ç†ç”¨æˆ·ä¸´æ—¶æ–‡ä»¶
    rm -rf ~/.cache/thumbnails/* 2>/dev/null || true
    rm -rf ~/.cache/mesa_shader_cache/* 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ ç³»ç»Ÿæ¸…ç†å®Œæˆ${NC}"
}

# æ£€æŸ¥NEXUS CLIæ˜¯å¦å®‰è£…
check_nexus_cli() {
    echo -e "\n${BLUE}[4/8] æ£€æŸ¥NEXUS CLI...${NC}"
    
    if command -v nexus-network &> /dev/null; then
        VERSION=$(nexus-network --version 2>/dev/null || echo "æœªçŸ¥ç‰ˆæœ¬")
        echo -e "${GREEN}âœ“ NEXUS CLIå·²å®‰è£…: $VERSION${NC}"
        return 0
    else
        echo -e "${YELLOW}! NEXUS CLIæœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…...${NC}"
        
        # å®‰è£…NEXUS CLI
        if curl -s https://cli.nexus.xyz/ | sh; then
            echo -e "${GREEN}âœ“ NEXUS CLIå®‰è£…æˆåŠŸ${NC}"
            
            # åˆ·æ–°ç¯å¢ƒå˜é‡
            source ~/.bashrc 2>/dev/null || source ~/.zshrc 2>/dev/null || true
            export PATH="$HOME/.nexus:$PATH"
            
            return 0
        else
            echo -e "${RED}âœ— NEXUS CLIå®‰è£…å¤±è´¥${NC}"
            return 1
        fi
    fi
}

# åˆ›å»ºä¼˜åŒ–é…ç½®
create_config() {
    echo -e "\n${BLUE}[5/8] åˆ›å»ºä¼˜åŒ–é…ç½®...${NC}"
    
    # åˆ›å»ºé…ç½®ç›®å½•
    mkdir -p ~/.nexus/config
    
    # åˆ›å»ºä¼˜åŒ–é…ç½®æ–‡ä»¶
    cat > ~/.nexus/config/optimization.conf << EOF
# NEXUSèŠ‚ç‚¹ä¼˜åŒ–é…ç½®
# é€‚ç”¨äºä½é…ç½®ç¡¬ä»¶

# CPUè®¾ç½® (é’ˆå¯¹åŒæ ¸å››çº¿ç¨‹i5-6200U)
CPU_LIMIT=70
MAX_WORKERS=2
THREAD_POOL_SIZE=4

# å†…å­˜è®¾ç½® (4GBç‰©ç† + 16GBè™šæ‹Ÿ)
MEMORY_LIMIT=6GB
SWAP_USAGE=moderate

# ç½‘ç»œè®¾ç½®
CONNECTION_TIMEOUT=30
RETRY_ATTEMPTS=3
BATCH_SIZE=small

# æ€§èƒ½è®¾ç½®
ENABLE_GPU=true
GPU_MEMORY_LIMIT=1GB
PROOF_CACHE_SIZE=2GB

# ç›‘æ§è®¾ç½®
ENABLE_MONITORING=true
LOG_LEVEL=info
STATS_INTERVAL=300
EOF
    
    echo -e "${GREEN}âœ“ ä¼˜åŒ–é…ç½®å·²åˆ›å»º${NC}"
}

# åˆ›å»ºå¯åŠ¨è„šæœ¬
create_start_script() {
    echo -e "\n${BLUE}[6/8] åˆ›å»ºä¼˜åŒ–å¯åŠ¨è„šæœ¬...${NC}"
    
    cat > ~/.nexus/start_optimized.sh << 'EOF'
#!/bin/bash

# NEXUSä¼˜åŒ–å¯åŠ¨è„šæœ¬
echo "å¯åŠ¨NEXUSèŠ‚ç‚¹ï¼ˆä¼˜åŒ–æ¨¡å¼ï¼‰..."

# åŠ è½½é…ç½®
CONFIG_FILE="$HOME/.nexus/config/optimization.conf"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
    echo "âœ“ å·²åŠ è½½ä¼˜åŒ–é…ç½®"
else
    echo "! è­¦å‘Š: æœªæ‰¾åˆ°ä¼˜åŒ–é…ç½®æ–‡ä»¶"
fi

# æ£€æŸ¥ç³»ç»Ÿèµ„æº
echo "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
FREE_MEM=$(free -m | awk 'NR==2{printf "%.1f", $7/1024}' 2>/dev/null || echo "æœªçŸ¥")
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}' 2>/dev/null || echo "æœªçŸ¥")

echo "å¯ç”¨å†…å­˜: ${FREE_MEM}GB"
echo "CPUä½¿ç”¨ç‡: ${CPU_USAGE}%"

# è®¾ç½®CPUä¼˜å…ˆçº§
renice -n 5 $$ 2>/dev/null || true

# å¯åŠ¨å‚æ•°
NEXUS_ARGS=""

# CPUé™åˆ¶
if [ ! -z "$CPU_LIMIT" ]; then
    NEXUS_ARGS="$NEXUS_ARGS --cpu-limit $CPU_LIMIT"
fi

# å·¥ä½œçº¿ç¨‹æ•°
if [ ! -z "$MAX_WORKERS" ]; then
    NEXUS_ARGS="$NEXUS_ARGS --workers $MAX_WORKERS"
fi

# æ£€æŸ¥èŠ‚ç‚¹ID
if [ -f "$HOME/.nexus/credentials.json" ]; then
    echo "âœ“ æ‰¾åˆ°ç°æœ‰å‡­æ®"
    NODE_ID=$(cat "$HOME/.nexus/credentials.json" | grep -o '"node_id":"[^"]*"' | cut -d'"' -f4 2>/dev/null || echo "")
    if [ ! -z "$NODE_ID" ]; then
        NEXUS_ARGS="$NEXUS_ARGS --node-id $NODE_ID"
        echo "âœ“ ä½¿ç”¨èŠ‚ç‚¹ID: $NODE_ID"
    fi
else
    echo "! éœ€è¦é¦–æ¬¡æ³¨å†Œ"
    echo "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ³¨å†Œ:"
    echo "nexus-network register-user --wallet-address <your-wallet-address>"
    echo "nexus-network register-node"
fi

# å¯åŠ¨NEXUS
echo "å¯åŠ¨å‘½ä»¤: nexus-network start $NEXUS_ARGS"
echo "æŒ‰Ctrl+Cåœæ­¢èŠ‚ç‚¹"
echo "=================================="

# å¯åŠ¨èŠ‚ç‚¹
nexus-network start $NEXUS_ARGS

EOF
    
    chmod +x ~/.nexus/start_optimized.sh
    echo -e "${GREEN}âœ“ ä¼˜åŒ–å¯åŠ¨è„šæœ¬å·²åˆ›å»º${NC}"
}

# åˆ›å»ºç›‘æ§è„šæœ¬
create_monitor_script() {
    echo -e "\n${BLUE}[7/8] åˆ›å»ºç›‘æ§è„šæœ¬...${NC}"
    
    cat > ~/.nexus/monitor.sh << 'EOF'
#!/bin/bash

# NEXUSèŠ‚ç‚¹ç›‘æ§è„šæœ¬
echo "NEXUSèŠ‚ç‚¹ç›‘æ§ - æŒ‰Ctrl+Cé€€å‡º"
echo "=================================="

while true; do
    clear
    echo "NEXUSèŠ‚ç‚¹çŠ¶æ€ç›‘æ§ - $(date)"
    echo "=================================="
    
    # CPUä½¿ç”¨ç‡
    if command -v top &> /dev/null; then
        CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}' 2>/dev/null || echo "N/A")
        echo "CPUä½¿ç”¨ç‡: ${CPU_USAGE}%"
    fi
    
    # å†…å­˜ä½¿ç”¨
    if command -v free &> /dev/null; then
        free -h | head -2
    fi
    
    echo ""
    
    # ç£ç›˜ä½¿ç”¨
    if command -v df &> /dev/null; then
        df -h / | tail -1 | awk '{print "ç£ç›˜ä½¿ç”¨: " $3 "/" $2 " (" $5 ")"}'
    fi
    
    echo ""
    
    # NEXUSè¿›ç¨‹çŠ¶æ€
    if pgrep -f "nexus-network" > /dev/null; then
        echo "âœ“ NEXUSèŠ‚ç‚¹æ­£åœ¨è¿è¡Œ"
        
        # è¿›ç¨‹èµ„æºä½¿ç”¨
        NEXUS_PID=$(pgrep -f "nexus-network" | head -1)
        if [ ! -z "$NEXUS_PID" ]; then
            if command -v ps &> /dev/null; then
                ps -o pid,pcpu,pmem,time,cmd -p $NEXUS_PID 2>/dev/null | tail -1
            fi
        fi
    else
        echo "âœ— NEXUSèŠ‚ç‚¹æœªè¿è¡Œ"
    fi
    
    echo ""
    echo "=================================="
    echo "5ç§’ååˆ·æ–°... (Ctrl+Cé€€å‡º)"
    
    sleep 5
done

EOF
    
    chmod +x ~/.nexus/monitor.sh
    echo -e "${GREEN}âœ“ ç›‘æ§è„šæœ¬å·²åˆ›å»º${NC}"
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo -e "\n${GREEN}[8/8] ä¼˜åŒ–å®Œæˆï¼${NC}"
    echo "=================================="
    echo -e "${YELLOW}ä½¿ç”¨è¯´æ˜:${NC}"
    echo ""
    echo "1. å¯åŠ¨ä¼˜åŒ–èŠ‚ç‚¹:"
    echo "   ~/.nexus/start_optimized.sh"
    echo ""
    echo "2. ç›‘æ§èŠ‚ç‚¹çŠ¶æ€:"
    echo "   ~/.nexus/monitor.sh"
    echo ""
    echo "3. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œè¯·å…ˆæ³¨å†Œ:"
    echo "   nexus-network register-user --wallet-address <ä½ çš„é’±åŒ…åœ°å€>"
    echo "   nexus-network register-node"
    echo ""
    echo "4. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€:"
    echo "   nexus-network status"
    echo ""
    echo "5. åœæ­¢èŠ‚ç‚¹:"
    echo "   æŒ‰Ctrl+Cæˆ–è¿è¡Œ: pkill -f nexus-network"
    echo ""
    echo -e "${YELLOW}ä¼˜åŒ–é…ç½®æ–‡ä»¶ä½ç½®:${NC}"
    echo "   ~/.nexus/config/optimization.conf"
    echo ""
    echo -e "${GREEN}é’ˆå¯¹ä½ çš„ç¡¬ä»¶é…ç½®çš„ä¼˜åŒ–:${NC}"
    echo "â€¢ CPUé™åˆ¶: 70% (é¿å…ç³»ç»Ÿå¡é¡¿)"
    echo "â€¢ å·¥ä½œçº¿ç¨‹: 2ä¸ª (é€‚åˆåŒæ ¸CPU)"
    echo "â€¢ å†…å­˜ç®¡ç†: ä¼˜åŒ–è™šæ‹Ÿå†…å­˜ä½¿ç”¨"
    echo "â€¢ GPUæ”¯æŒ: å¯ç”¨NVIDIA 920MX"
    echo ""
    echo "=================================="
}

# ä¸»å‡½æ•°
main() {
    echo "å¼€å§‹NEXUSèŠ‚ç‚¹ä¼˜åŒ–..."
    
    # æ³¨é‡Šæ‰ç®¡ç†å‘˜æƒé™æ£€æŸ¥ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰æ“ä½œéƒ½éœ€è¦
    # check_admin
    
    check_system
    optimize_system
    cleanup_resources
    check_nexus_cli
    create_config
    create_start_script
    create_monitor_script
    show_usage
    
    echo -e "\n${GREEN}ğŸ‰ NEXUSèŠ‚ç‚¹ä¼˜åŒ–è„šæœ¬æ‰§è¡Œå®Œæˆï¼${NC}"
    echo -e "${BLUE}ç°åœ¨å¯ä»¥è¿è¡Œ ~/.nexus/start_optimized.sh å¯åŠ¨ä¼˜åŒ–åçš„èŠ‚ç‚¹${NC}"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
